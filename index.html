<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€ŠAIåšå¾·ä¹‹é—¨-å¼‚ä¹éƒ½çº¢ç§»åˆ‡ç‰‡ã€‹æˆ˜å½¹å¼•æ“</title>
    <style>
        /* --- ä¿æŒä¹‹å‰çš„ CSS æ ·å¼å®Œå…¨ä¸å˜ --- */
        :root {
            --bg-dark: #050505; --panel-bg: #121214; --text-main: #e2e8f0;
            --text-muted: #8b949e; --accent: #e11d48; --accent-hover: #be123c;
            --border: #27272a; --flag-true: #10b981; --locked: #2d2d30;
            --reading-bg: #0d0d0f;
        }
        body { font-family: 'PingFang SC', 'Microsoft YaHei', 'Segoe UI', system-ui, sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--panel-bg); border-bottom: 1px solid var(--border); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 10; }
        h1 { margin: 0; font-size: 20px; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; text-shadow: 0 0 10px rgba(225, 29, 72, 0.3); }
        .nav-tabs { display: flex; gap: 10px; }
        .nav-btn { background: transparent; color: var(--text-muted); border: 1px solid transparent; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .nav-btn:hover { color: var(--text-main); background: rgba(255,255,255,0.05); }
        .nav-btn.active { background: rgba(225, 29, 72, 0.1); color: var(--accent); border-color: var(--accent); font-weight: bold; }
        .container { padding: 20px; flex: 1; overflow-y: auto; display: none; }
        .container.active { display: block; }
        button.primary { background: var(--accent); color: #fff; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background 0.2s; letter-spacing: 1px;}
        button.primary:hover { background: var(--accent-hover); box-shadow: 0 0 15px rgba(225, 29, 72, 0.4); }
        button.success { background: var(--flag-true); color: #000; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px;}
        .admin-login-view { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 20px; }
        .admin-login-view input { background: #000; border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 6px; text-align: center; font-size: 16px; width: 250px; outline: none; }
        .admin-content-view { display: flex; gap: 20px; height: 100%; align-items: flex-start; }
        .admin-col { flex: 1; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; padding: 20px; display: flex; flex-direction: column; height: calc(100vh - 120px); }
        textarea { height: 200px; background: #000; color: var(--text-main); border: 1px solid var(--border); border-radius: 4px; padding: 15px; font-family: monospace; resize: vertical; margin-bottom: 15px; }
        .game-list-admin { display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-right: 10px; }
        .admin-campaign-group { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .collapse-header { cursor: pointer; display: flex; justify-content: space-between; align-items: flex-start; user-select: none; transition: color 0.2s; }
        .collapse-icon { font-size: 12px; transition: transform 0.3s; color: var(--text-muted); margin-top: 5px;}
        .collapsed-group .collapse-icon { transform: rotate(-90deg); }
        .collapse-content { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; overflow: hidden; }
        .collapsed-group .collapse-content { display: none; }
        .admin-campaign-group h3 { margin: 0; color: inherit; border-bottom: 1px solid var(--border); padding-bottom: 10px; font-size: 16px; flex: 1; }
        .campaign-meta-editor textarea { height: 70px; width: 100%; box-sizing: border-box; background: #000; color: var(--text-main); border: 1px dashed var(--border); border-radius: 4px; padding: 10px; font-family: inherit; font-size: 13px; margin-bottom: 15px; resize: vertical; }
        .admin-game-card { background: #000; border: 1px solid var(--border); padding: 15px; border-radius: 6px; display: flex; flex-direction: column; gap: 10px; }
        .editor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .editor-item { display: flex; flex-direction: column; gap: 5px; font-size: 12px; color: var(--text-muted); }
        .editor-item input { background: var(--panel-bg); border: 1px solid var(--border); color: var(--text-main); padding: 8px; border-radius: 4px; }
        .delete-btn { color: #ef4444; cursor: pointer; background: none; border: 1px solid #ef4444; padding: 4px 10px; border-radius: 4px; font-size: 12px; }
        .campaign-section { margin-bottom: 40px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .reset-btn { font-size: 12px; color: var(--text-muted); cursor: pointer; background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 6px 12px; border-radius: 4px; }
        .campaign-progress-bar { width: 180px; height: 6px; background: #000; border: 1px solid var(--border); border-radius: 3px; overflow: hidden; display: inline-block; vertical-align: middle; }
        .progress-fill { height: 100%; background: var(--accent); transition: width 0.5s ease-out; box-shadow: 0 0 10px var(--accent); }
        .progress-text { font-size: 15px; color: var(--accent); font-weight: bold; font-family: monospace; }
        .campaign-stats { margin-top: 12px; font-size: 13px; color: var(--text-muted); display: flex; gap: 15px; flex-wrap: wrap; }
        .campaign-stats span { background: #08080a; padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border); }
        .highlight-ending { color: var(--flag-true); font-weight: bold; }
        .campaign-desc-box { margin-top: 20px; padding: 15px 20px; background: rgba(0,0,0,0.4); border-left: 3px solid var(--accent); border-radius: 4px; font-size: 14px; color: var(--text-muted); line-height: 1.7; }
        .lobby-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 25px; }
        .story-card { background: #08080a; border: 1px solid var(--border); border-radius: 8px; padding: 25px; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; overflow: hidden; }
        .story-card.playable { cursor: pointer; }
        .story-card.playable:hover { transform: translateY(-5px); border-color: var(--accent); }
        .story-card.completed { border-color: var(--locked); opacity: 0.5; cursor: not-allowed; }
        .story-card.completed::after { content: "DATA SYNced"; position: absolute; top: 15px; right: -30px; background: var(--flag-true); color: #000; font-size: 10px; font-weight: bold; padding: 4px 30px; transform: rotate(45deg); letter-spacing: 1px;}
        .story-card h3 { margin: 0 0 10px 0; color: var(--text-main); font-size: 18px; }
        .story-card p { margin: 0; color: var(--text-muted); font-size: 14px; line-height: 1.6; }
        .play-layout { display: flex; gap: 20px; height: 100%; justify-content: center; }
        .play-main { flex: 1; max-width: 800px; background: var(--reading-bg); border: 1px solid var(--border); border-radius: 8px; padding: 40px; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.8); position: relative; overflow: hidden;}
        .play-main::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); z-index: 1; background-size: 100% 2px, 3px 100%; pointer-events: none; opacity: 0.3;}
        .play-sidebar { width: 300px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 25px; height: fit-content; max-height: 100%; overflow-y: auto;}
        .story-text { font-size: 17px; line-height: 1.85; letter-spacing: 0.5px; color: #f1f5f9; flex: 1; overflow-y: auto; margin-bottom: 30px; padding-right: 15px; z-index: 2; position: relative;}
        .story-text p { margin-top: 0; margin-bottom: 1.5em; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .options-container { display: flex; flex-direction: column; gap: 12px; z-index: 2; position: relative; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.05);}
        .option-btn { background: rgba(0,0,0,0.4); color: var(--text-main); text-align: left; padding: 16px 20px; border-radius: 6px; border: 1px solid var(--border); border-left: 3px solid var(--border); cursor: pointer; transition: all 0.2s ease; font-size: 15px; line-height: 1.4;}
        .option-btn:hover { background: rgba(225, 29, 72, 0.1); border-color: var(--accent); border-left: 3px solid var(--accent); transform: translateX(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.3);}
        .flag-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed rgba(255,255,255,0.05); font-family: monospace; font-size: 13px;}
        .flag-value { color: var(--text-muted); }
        .flag-value.true { color: var(--flag-true); font-weight: bold; text-shadow: 0 0 5px rgba(16, 185, 129, 0.4);}
        .fade-in-up { animation: fadeInUp 0.4s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <h1>ã€Šå¼‚ä¹éƒ½çº¢ç§»åˆ‡ç‰‡ã€‹ç»ˆç«¯</h1>
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchTab('player-lobby')">å¤§å… (ç©å®¶æ¨¡å¼)</button>
            <button class="nav-btn" onclick="switchTab('admin-panel')">ç¼–æ’ (ç®¡ç†å‘˜æ¨¡å¼)</button>
        </div>
    </header>

    <div id="admin-panel" class="container">
        <div id="admin-login-screen" class="admin-login-view">
            <h2 style="color: var(--accent); margin-bottom: 5px;">åè®®é”å®š</h2>
            <p style="color: var(--text-muted); font-size: 14px;">è¯·è¾“å…¥åº•å±‚é€»è¾‘ç»ˆç«¯è®¿é—®å¯†é’¥</p>
            <input type="password" id="adminPwd" placeholder="Password" onkeypress="if(event.key==='Enter') checkAdminPwd()">
            <button class="primary" onclick="checkAdminPwd()">éªŒè¯æˆæƒ</button>
        </div>
        <div id="admin-content-screen" class="admin-content-view" style="display: none;">
            <div class="admin-col" style="flex: 0.8;">
                <h2 style="margin-top:0;">1. è½½å…¥æ–°åˆ‡ç‰‡</h2>
                <textarea id="jsonInput" placeholder="{'title': '...', 'nodes': {...}}"></textarea>
                <button class="primary" onclick="importJson()">è½½å…¥åˆ°å¾…ç¼–æ’åº“</button>
            </div>
            <div class="admin-col" style="flex: 1.5;">
                <h2 style="margin-top:0; display:flex; justify-content:space-between; align-items:center;">
                    2. æˆ˜å½¹æµå…³ç³»ç¼–æ’
                    <div>
                        <button class="primary success" style="font-size:12px; padding:6px 12px;" onclick="exportGameData()">â¬‡ï¸ å¯¼å‡ºå‘å¸ƒæ–‡ä»¶ (gamedata.json)</button>
                        <button class="nav-btn" style="font-size:12px; padding:4px 8px;" onclick="toggleAllFolders(false)">å±•å¼€å…¨éƒ¨</button>
                    </div>
                </h2>
                <div class="game-list-admin" id="adminGameList"></div>
            </div>
        </div>
    </div>

    <div id="player-lobby" class="container active">
        <div id="lobbyContent" style="max-width: 1200px; margin: 0 auto;"></div>
    </div>

    <div id="player-game" class="container">
        <div style="max-width: 1120px; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="nav-btn" onclick="switchTab('player-lobby')" style="border: 1px solid var(--border);">â† é€ƒç¦»åˆ‡ç‰‡</button>
                <button class="nav-btn" id="btnRewind" onclick="rewindTime()" style="border: 1px solid var(--border); color: var(--flag-true); display: none; font-weight: bold;">âŸ² æ™¶ä½“ç®¡å›æº¯</button>
                <span id="currentGameTitle" style="color: var(--text-muted); font-size: 14px; letter-spacing: 1px;"></span>
            </div>
        </div>
        <div class="play-layout">
            <div class="play-main">
                <div class="story-text" id="storyText">è½½å…¥ä¸­...</div>
                <div class="options-container" id="optionsContainer"></div>
            </div>
            <div class="play-sidebar">
                <h3 style="margin-top:0; border-bottom: 1px solid var(--border); padding-bottom:10px; font-size: 14px; color: var(--text-muted); text-transform: uppercase;">ç³»ç»Ÿå…¨å±€å˜é‡ç›‘æ§</h3>
                <div id="flagsContainer"></div>
            </div>
        </div>
    </div>

    <script>
        let gameLibrary = []; 
        let playerProgress = JSON.parse(localStorage.getItem('yiledu_progress')) || {}; 
        let campaignMeta = {};
        let adminCollapsedStates = {}; 
        let lobbyCollapsedStates = {};
        let currentGameData = null;
        let currentCampaign = "";
        let isAdminAuthenticated = false; 
        let sessionHistory = []; 
        let currentNodeId = 'start';

        async function init() {
            await loadRemoteData();
            const localLib = localStorage.getItem('yiledu_library');
            const localMeta = localStorage.getItem('yiledu_campaign_meta');
            if (localLib) gameLibrary = JSON.parse(localLib);
            if (localMeta) campaignMeta = JSON.parse(localMeta);
            renderLobby();
        }

        async function loadRemoteData() {
            try {
                const response = await fetch('gamedata.json');
                if (response.ok) {
                    const data = await response.json();
                    gameLibrary = data.library || [];
                    campaignMeta = data.meta || {};
                }
            } catch (e) {}
        }

        function exportGameData() {
            const data = { library: gameLibrary, meta: campaignMeta };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "gamedata.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(tabId === 'player-lobby') {
                document.querySelectorAll('.nav-btn')[0].classList.add('active');
                renderLobby();
            }
            if(tabId === 'admin-panel') {
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
                if(!isAdminAuthenticated) {
                    document.getElementById('admin-login-screen').style.display = 'flex';
                    document.getElementById('admin-content-screen').style.display = 'none';
                } else {
                    document.getElementById('admin-login-screen').style.display = 'none';
                    document.getElementById('admin-content-screen').style.display = 'flex';
                    renderAdminList();
                }
            }
        }

        function checkAdminPwd() {
            const pwd = document.getElementById('adminPwd').value;
            if (pwd === 'hi123') {
                isAdminAuthenticated = true;
                document.getElementById('adminPwd').value = '';
                switchTab('admin-panel'); 
            } else { alert('æˆæƒå¤±è´¥ï¼šå¯†é’¥æ— æ•ˆã€‚'); }
        }

        function toggleFolder(campaignName, viewType) {
            if (viewType === 'admin') {
                adminCollapsedStates[campaignName] = !adminCollapsedStates[campaignName];
                renderAdminList();
            } else {
                lobbyCollapsedStates[campaignName] = !lobbyCollapsedStates[campaignName];
                renderLobby();
            }
        }

        function toggleAllFolders(forceCollapse) {
            const campaigns = [...new Set(gameLibrary.map(g => g.campaign_name || "æœªåˆ†ç±»"))];
            campaigns.forEach(c => adminCollapsedStates[c] = forceCollapse);
            renderAdminList();
        }

        function importJson() {
            try {
                const jsonStr = document.getElementById('jsonInput').value;
                const newGame = JSON.parse(jsonStr);
                if (!newGame.nodes || !newGame.nodes.start) throw new Error("ç¼ºå°‘ nodes.start");
                newGame.id = "game_" + Date.now();
                newGame.campaign_name = newGame.campaign_name || "æœªåˆ†ç±»";
                newGame.completion_flag = newGame.completion_flag || "completed_" + Math.floor(Math.random()*1000);
                newGame.prerequisites = newGame.prerequisites || [];
                newGame.initial_flags = newGame.global_flags || {};
                gameLibrary.push(newGame);
                saveLibrary();
                adminCollapsedStates[newGame.campaign_name] = false;
                document.getElementById('jsonInput').value = '';
                renderAdminList();
            } catch (e) { alert("JSON è§£æå¤±è´¥: " + e.message); }
        }

        function saveLibrary() { 
            localStorage.setItem('yiledu_library', JSON.stringify(gameLibrary)); 
            localStorage.setItem('yiledu_campaign_meta', JSON.stringify(campaignMeta));
        }
        
        function updateCampaignMeta(cName, desc) {
            if (!campaignMeta[cName]) campaignMeta[cName] = {};
            campaignMeta[cName].description = desc;
            saveLibrary();
        }

        function updateGameField(id, field, value) {
            const game = gameLibrary.find(g => g.id === id);
            if (!game) return;
            if (field === 'campaign_name') adminCollapsedStates[value] = false; 
            if (field === 'prerequisites') {
                game[field] = value.split(',').map(s => s.trim()).filter(s => s);
            } else { game[field] = value; }
            saveLibrary();
            renderAdminList(); 
        }

        function deleteGame(id) {
            if(confirm("ç¡®å®šé”€æ¯è¿™ä¸ªåˆ‡ç‰‡å—ï¼Ÿ")) {
                gameLibrary = gameLibrary.filter(g => g.id !== id);
                saveLibrary();
                renderAdminList();
            }
        }

        function renderAdminList() {
            const list = document.getElementById('adminGameList');
            list.innerHTML = '';
            const campaigns = {};
            gameLibrary.forEach(g => {
                const cName = g.campaign_name || "æœªåˆ†ç±»";
                if (!campaigns[cName]) campaigns[cName] = [];
                campaigns[cName].push(g);
            });
            for (const [cName, games] of Object.entries(campaigns)) {
                const isCollapsed = adminCollapsedStates[cName] || false;
                const descText = campaignMeta[cName]?.description || '';
                const groupDiv = document.createElement('div');
                groupDiv.className = `admin-campaign-group ${isCollapsed ? 'collapsed-group' : ''}`;
                groupDiv.innerHTML = `
                    <div class="collapse-header" onclick="toggleFolder('${cName}', 'admin')">
                        <h3 style="display:flex; align-items:center;">ğŸ“ æ¡£æ¡ˆå¤¹ï¼š${cName} <span style="font-size:12px; font-weight:normal; color:var(--text-muted); margin-left:10px;">(${games.length} ä¸ªåˆ‡ç‰‡)</span></h3>
                        <span class="collapse-icon">â–¼</span>
                    </div>
                `;
                const contentDiv = document.createElement('div');
                contentDiv.className = 'collapse-content';
                contentDiv.innerHTML += `
                    <div class="campaign-meta-editor">
                        <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 6px;">âœï¸ æˆ˜å½¹å…¨å±€ç®€ä»‹</label>
                        <textarea data-cname="${cName.replace(/"/g, '&quot;')}" onchange="updateCampaignMeta(this.dataset.cname, this.value)">${descText}</textarea>
                    </div>
                `;
                games.forEach(game => {
                    const prereqStr = (game.prerequisites || []).join(', ');
                    contentDiv.innerHTML += `
                        <div class="admin-game-card">
                            <header>
                                <h4>[åˆ‡ç‰‡] ${game.title || 'æ— æ ‡é¢˜'}</h4>
                                <button class="delete-btn" onclick="deleteGame('${game.id}')">é”€æ¯</button>
                            </header>
                            <div class="editor-grid">
                                <div class="editor-item"><label>æ‰€å±å¤§ç« èŠ‚</label><input type="text" value="${game.campaign_name}" onchange="updateGameField('${game.id}', 'campaign_name', this.value)"></div>
                                <div class="editor-item"><label>æœ¬åˆ‡ç‰‡é€šå…³æ ‡è®°</label><input type="text" value="${game.completion_flag}" onchange="updateGameField('${game.id}', 'completion_flag', this.value)"></div>
                                <div class="editor-item" style="grid-column: span 2;"><label>è¿›å…¥å‰ç½®æ¡ä»¶ (é€—å·åˆ†éš”)</label><input type="text" value="${prereqStr}" onchange="updateGameField('${game.id}', 'prerequisites', this.value)"></div>
                            </div>
                        </div>
                    `;
                });
                groupDiv.appendChild(contentDiv);
                list.appendChild(groupDiv);
            }
        }

        function resetCampaignProgress(campaignName) {
            if(confirm(`ç¡®å®šè¦æ¸…ç©ºã€${campaignName}ã€‘çš„æ‰€æœ‰è¿›åº¦å—ï¼Ÿ`)) {
                delete playerProgress[campaignName];
                localStorage.setItem('yiledu_progress', JSON.stringify(playerProgress));
                renderLobby();
            }
        }

        function renderLobby() {
            const container = document.getElementById('lobbyContent');
            container.innerHTML = '';
            if (gameLibrary.length === 0) {
                container.innerHTML = '<p style="color:var(--text-muted); text-align:center; margin-top: 50px;">æ¡£æ¡ˆåº“ä¸ºç©ºã€‚</p>';
                return;
            }
            const campaigns = {};
            gameLibrary.forEach(g => {
                const cName = g.campaign_name || "æœªåˆ†ç±»";
                if (!campaigns[cName]) campaigns[cName] = [];
                campaigns[cName].push(g);
            });
            for (const [cName, games] of Object.entries(campaigns)) {
                if (!playerProgress[cName]) playerProgress[cName] = {};
                const currentProgress = playerProgress[cName];
                const descText = campaignMeta[cName]?.description || 'è¯¥æˆ˜å½¹æ¡£æ¡ˆåº“å°šæœªå½•å…¥å…¨å±€èƒŒæ™¯æ¦‚è¿°ã€‚';
                const totalGames = games.length;
                let completedCount = 0;
                games.forEach(g => { if(currentProgress[g.completion_flag]) completedCount++; });
                const progressPercent = totalGames === 0 ? 0 : Math.round((completedCount / totalGames) * 100);
                const playCount = currentProgress._play_count || 0;
                const achievedEndings = currentProgress._achieved_endings || [];
                const endingsHtml = achievedEndings.length > 0 
                    ? achievedEndings.map(e => `<span class="highlight-ending">${e}</span>`).join(' / ') 
                    : 'æš‚æ— ';
                const section = document.createElement('div');
                const isCollapsed = lobbyCollapsedStates[cName] || false;
                section.className = `campaign-section ${isCollapsed ? 'collapsed-group' : ''}`;
                section.innerHTML = `
                    <div class="collapse-header" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 20px; align-items: flex-start;" onclick="toggleFolder('${cName}', 'lobby')">
                        <div style="flex: 1;">
                            <h2 style="margin:0 0 10px 0; font-size: 22px; display:flex; align-items:center; gap: 15px;">
                                æ¡£æ¡ˆå¤¹ï¼š${cName}
                                <span class="campaign-progress-bar">
                                    <div class="progress-fill" style="width: ${progressPercent}%;"></div>
                                </span>
                                <span class="progress-text">${progressPercent}%</span>
                            </h2>
                            <div class="campaign-stats">
                                <span>ğŸ”„ ç´¯è®¡è¾¾æˆç»“å±€: <strong style="color:var(--text-main);">${playCount}</strong> æ¬¡</span>
                                <span>ğŸ† æ”¶å½•ç»ˆç„‰é”šç‚¹: ${endingsHtml}</span>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap: 15px; padding-top: 5px;">
                            <button class="reset-btn" onclick="event.stopPropagation(); resetCampaignProgress('${cName}')">â†º æ“¦é™¤æˆ˜å½¹è®°å¿†</button>
                            <span class="collapse-icon">â–¼</span>
                        </div>
                    </div>
                    <div class="collapse-content">
                        <div class="campaign-desc-box">${descText.replace(/\n/g, '<br>')}</div>
                        <div class="lobby-grid"></div>
                    </div>
                `;
                const grid = section.querySelector('.lobby-grid');
                let visibleCount = 0;
                games.forEach(game => {
                    const prereqs = game.prerequisites || [];
                    const isUnlocked = prereqs.length === 0 || prereqs.every(req => currentProgress[req] === true);
                    if (!isUnlocked) return;
                    visibleCount++;
                    const isCompleted = currentProgress[game.completion_flag] === true;
                    const card = document.createElement('div');
                    card.className = `story-card ${isCompleted ? 'completed' : 'playable'}`;
                    card.innerHTML = `<h3>${game.title}</h3><p>${game.summary || 'æœªçŸ¥çš„è®°å¿†ç‰‡æ®µã€‚'}</p>`;
                    if (!isCompleted) { card.onclick = () => startGame(game.id, cName); }
                    grid.appendChild(card);
                });
                if (visibleCount > 0) { container.appendChild(section); }
            }
        }

        function startGame(gameId, campaignName) {
            currentGameData = gameLibrary.find(g => g.id === gameId);
            currentCampaign = campaignName;
            sessionHistory = []; 
            currentNodeId = 'start';
            updateRewindUI();
            if (!playerProgress[currentCampaign]) playerProgress[currentCampaign] = {};
            if (currentGameData.initial_flags) {
                for (const [k, v] of Object.entries(currentGameData.initial_flags)) {
                    if (playerProgress[currentCampaign][k] === undefined) {
                        playerProgress[currentCampaign][k] = v;
                    }
                }
            }
            document.getElementById('currentGameTitle').textContent = `// LOCATION: [${currentCampaign}] / ${currentGameData.title}`;
            switchTab('player-game');
            renderFlags();
            renderNode('start');
        }

        function saveProgress() { localStorage.setItem('yiledu_progress', JSON.stringify(playerProgress)); }

        function renderFlags() {
            const container = document.getElementById('flagsContainer');
            container.innerHTML = '';
            const progress = playerProgress[currentCampaign];
            for (const [key, value] of Object.entries(progress)) {
                if (key.startsWith('completed_') || key.startsWith('_')) continue; 
                container.innerHTML += `<div class="flag-item"><span>${key}</span><span class="flag-value ${value}">${value}</span></div>`;
            }
        }

        function rewindTime() {
            if (sessionHistory.length === 0) return;
            const previous = sessionHistory.pop();
            const metaPlayCount = playerProgress[currentCampaign]._play_count;
            const metaEndings = playerProgress[currentCampaign]._achieved_endings;
            playerProgress[currentCampaign] = previous.state;
            if (metaPlayCount !== undefined) playerProgress[currentCampaign]._play_count = metaPlayCount;
            if (metaEndings !== undefined) playerProgress[currentCampaign]._achieved_endings = metaEndings;
            saveProgress();
            renderFlags();
            currentNodeId = previous.nodeId;
            renderNode(currentNodeId);
            updateRewindUI();
        }

        function updateRewindUI() {
            const btn = document.getElementById('btnRewind');
            btn.style.display = sessionHistory.length > 0 ? 'inline-block' : 'none';
        }

        function renderNode(nodeId) {
            const node = currentGameData.nodes[nodeId];
            if (!node) return;
            currentNodeId = nodeId;
            const storyBox = document.getElementById('storyText');
            const paragraphs = node.text.split('\n').filter(p => p.trim() !== '');
            const textHtml = paragraphs.map(p => `<p>${p}</p>`).join('');
            storyBox.innerHTML = textHtml;
            storyBox.classList.remove('fade-in-up');
            void storyBox.offsetWidth; 
            storyBox.classList.add('fade-in-up');
            const optionsBox = document.getElementById('optionsContainer');
            optionsBox.innerHTML = '';
            optionsBox.classList.remove('fade-in-up');
            void optionsBox.offsetWidth;
            optionsBox.classList.add('fade-in-up');
            const progress = playerProgress[currentCampaign];
            
            // --- èŠ‚ç‚¹åˆ¤å®šé€»è¾‘ ---
            const isEndOfScenario = !node.options || node.options.length === 0;
            const isEndOfChapterOnly = isEndOfScenario && !nodeId.startsWith('end_');

            if (isEndOfScenario) {
                 if (node.effects) {
                     for (const [k, v] of Object.entries(node.effects)) progress[k] = v;
                 }
                 progress[currentGameData.completion_flag] = true;
                 
                 // --- æ ¸å¿ƒæ›´æ–°ï¼šåªæœ‰ä»¥ end_ å¼€å¤´çš„æ‰æ˜¯çœŸæ­£çš„ç»“å±€èŠ‚ç‚¹ï¼Œè®°å½•æˆå°± ---
                 if (nodeId.startsWith('end_')) {
                     progress._play_count = (progress._play_count || 0) + 1;
                     progress._achieved_endings = progress._achieved_endings || [];
                     let endingName = "æœªçŸ¥ç»ˆç‚¹";
                     const match = node.text.match(/ã€(.*?)ã€‘/);
                     if (match) {
                         endingName = match[1];
                     } else {
                         endingName = nodeId.replace('end_', 'ç»“å±€: ');
                     }
                     if (!progress._achieved_endings.includes(endingName)) {
                         progress._achieved_endings.push(endingName);
                     }
                 }

                 saveProgress();
                 renderFlags();

                 const btn = document.createElement('button');
                 btn.className = 'option-btn';
                 btn.style.textAlign = 'center'; btn.style.color = 'var(--accent)'; btn.style.fontWeight = 'bold';
                 btn.textContent = ">>> " + (nodeId.startsWith('end_') ? "ç»ˆç„‰å·²è‡³ï¼Œä¸Šä¼ è®°å¿†æ¡£æ¡ˆ" : "åˆ‡ç‰‡åŒæ­¥å®Œæˆï¼Œè¿”å›æ•°æ®å¤§å…");
                 btn.onclick = () => switchTab('player-lobby');
                 optionsBox.appendChild(btn);

                 if (sessionHistory.length > 0) {
                     const btnRewind = document.createElement('button');
                     btnRewind.className = 'option-btn';
                     btnRewind.style.textAlign = 'center'; btnRewind.style.color = 'var(--flag-true)';
                     btnRewind.textContent = "âŸ² å¯åŠ¨æ—¶ç©ºå›æº¯ (å°è¯•å…¶ä»–å¯èƒ½æ€§)";
                     btnRewind.onclick = () => rewindTime();
                     optionsBox.appendChild(btnRewind);
                 }
                 return;
            }

            node.options.forEach(opt => {
                let canShow = true;
                if (opt.required_flags_true) {
                    for (let flag of opt.required_flags_true) { if (progress[flag] !== true) { canShow = false; break; } }
                }
                if (canShow && opt.required_flags_false) {
                    for (let flag of opt.required_flags_false) { if (progress[flag] === true) { canShow = false; break; } }
                }
                if (!canShow) return; 

                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt.text; 
                btn.onclick = () => {
                    sessionHistory.push({ nodeId: currentNodeId, state: JSON.parse(JSON.stringify(progress)) });
                    updateRewindUI();
                    if (opt.effects) {
                        for (const [k, v] of Object.entries(opt.effects)) progress[k] = v;
                        saveProgress();
                        renderFlags();
                    }
                    if (opt.next_node) renderNode(opt.next_node);
                };
                optionsBox.appendChild(btn);
            });
            storyBox.scrollTop = 0;
        }
        window.onload = init;
    </script>
</body>
</html>
